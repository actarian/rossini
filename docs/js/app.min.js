!function(){"use strict";angular.module("app",["ngRoute","jsonFormatter"])}(),function(){"use strict";angular.module("app").config(["$httpProvider",function(e){}])}(),function(){"use strict";angular.module("app").config(["$locationProvider",function(e){e.html5Mode(!0),e.hashPrefix("")}])}(),function(){"use strict";angular.module("app").run(["$rootScope",function(e){}])}(),function(){"use strict";function e(e,o){for(var t=e*o,r=new Uint8Array(t),a=new n,i=1,c=100*Math.random(),s=0;s<4;s++){for(var l=0;l<t;l++){var u=l%e,d=~~(l/e);r[l]+=Math.abs(a.noise(u/i,d/i,c)*i*1.75)}i*=5}return r}function n(){function e(e){return e*e*e*(e*(6*e-15)+10)}function n(e,n,o){return n+e*(o-n)}function o(e,n,o,t){var r=15&e,a=r<8?n:o,i=r<4?o:12==r||14==r?n:t;return(0==(1&r)?a:-a)+(0==(2&r)?i:-i)}for(var t=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],r=0;r<256;r++)t[256+r]=t[r];return{noise:function(r,a,i){var c=Math.floor(r),s=Math.floor(a),l=Math.floor(i),u=255&c,d=255&s,p=255&l;r-=c,a-=s,i-=l;var g=r-1,h=a-1,v=i-1,m=e(r),f=e(a),w=e(i),E=t[u]+d,b=t[E]+p,y=t[E+1]+p,H=t[u+1]+d,S=t[H]+p,T=t[H+1]+p;return n(w,n(f,n(m,o(t[b],r,a,i),o(t[S],g,a,i)),n(m,o(t[y],r,h,i),o(t[T],g,h,i))),n(f,n(m,o(t[b+1],r,a,v),o(t[S+1],g,a,i-1)),n(m,o(t[y+1],r,h,v),o(t[T+1],g,h,v))))}}}function o(e,n,o){var t=2*Math.random()-1,r=Math.abs(t);return(o?Math.floor(t/r):1)*(e+(n-e)*r)}var t=angular.module("app");Number.prototype.mod=function(e){return(this%e+e)%e},t.service("AnalyserService",["$rootScope","$q","$http","SceneOptions","StepperService",function(e,n,o,t,r){function a(){var e,n,o=window.AudioContext||window.webkitAudioContext;e=null,n=new o,l=n.createAnalyser(),u=new Audio,u.addEventListener("canplay",function(){var o;return console.log("audio canplay"),e=n.createMediaElementSource(u),e.connect(l),e.connect(n.destination),l.fftSize=2*g.bands,o=l.frequencyBinCount,p.data=new Uint8Array(o),p.data}),c()}function i(e){d!==e&&(d=e,u.src=e,u.volume=g.audioVolume,u.play())}function c(){i(h.getCurrentStep().audio.url)}function s(){p.data&&l.getByteFrequencyData(p.data)}var l,u,d,p=this,g=t,h=r;e.$on("onStepChanged",function(e){c()}),e.$on("onOptionsChanged",function(e){u&&(u.volume=g.audioVolume)}),this.audio=u,this.data=null,this.init=a,this.update=s}]),t.directive("scene",["SceneOptions","StepperService","AnalyserService",function(n,t,r){return{restrict:"A",scope:{data:"=scene"},link:function(a,i,c){function s(){function e(){console.log("objects.ribbon.add"),w.add(m)}function n(){console.log("objects.ribbon.remove"),w.remove(m)}function t(){var e=1/v.steps.length*.1,n=v.values.pow,o=(n+e).mod(1),t=(v.getCurrentStep(),u.getPointAt(n));t.y+=v.values.cameraHeight;var r=u.getPointAt(o);r.y+=v.values.targetHeight,E.position.copy(t),E.target.copy(r),E.lookAt(E.target)}function r(){new THREE.Vector2(window.innerWidth,window.innerHeight);return new MeshLineMaterial({color:v.values.lines,lineWidth:5,depthTest:!0})}function a(){g.ribbon.material=r(),g.ribbon.object.material=g.ribbon.material}var i=r(),c=new THREE.Vector3,s=new Array(h.ribbon.points).fill(null).map(function(){var e=(new THREE.Vector3).copy(c);return c.x+=o(500,1e3,!0),c.y+=o(5,20,!0),c.z+=o(1e3,2e3,!1),e}),l=new THREE.CatmullRomCurve3(s);l.type="catmullrom",l.closed=!1;var u=new THREE.CatmullRomCurve3(l.points.map(function(e){return new THREE.Vector3(e.x,e.y+20,e.z)}));u.type="catmullrom",u.closed=!1;var d=new THREE.Geometry;d.vertices=l.getPoints(h.ribbon.vertices);var p=new MeshLine;p.setGeometry(d);var m=new THREE.Mesh(p.geometry,i);return e(),E.target=E.target||new THREE.Vector3(0,0,0),{object:m,spline:l,cameraSpline:u,geometry:d,material:i,add:e,remove:n,update:t,updateMaterial:a}}function l(e){function n(){console.log("objects.circles.add"),w.add(u),G.adding=Date.now(),G.removing=!1,G.enabled=!0,G.tween&&G.tween.kill(),G.tween=TweenLite.to(G,G.duration,{pow:1,delay:0,ease:Elastic.easeOut.config(1,.3),onComplete:function(){G.adding=!1}})}function o(){console.log("objects.circles.remove"),G.adding=!1,G.removing=Date.now(),G.tween&&G.tween.kill(),G.tween=TweenLite.to(G,G.duration,{pow:0,delay:0,ease:Power2.easeOut,onComplete:function(){G.removing=!1,G.enabled=!1,w.remove(u)}})}function t(e,n){var o=new THREE.Geometry,t=a(o,n,1);C.push(t);var r=null;if(O){var i=new MeshLine;i.setGeometry(o),k.push(o),M.push(i),r=new THREE.Mesh(i.geometry,S)}else r=new THREE.LineLoop(o,y);return P.add(r),r}function r(e,n){var o=new THREE.Geometry,t=a(o,n,2);R.push(t);var r=null;if(O){var i=new MeshLine;i.setGeometry(o),A.push(o),L.push(i),r=new THREE.Mesh(i.geometry,T)}else r=new THREE.LineLoop(o,H);return z.add(r),r}function a(n,o,t){var r=new Array(j).fill(null).map(function(r,a){var i=a/j,c=360*i;c+=60*e,c+=30*t,c+=360/j*.1*o;var s=c*Math.PI/180,l=h.radius,u=0;return u+=o*o*o*.005,r=new THREE.Vector3,r.sincos={base:l,increment:u,radius:l,x:Math.cos(s),y:Math.sin(s)},n.vertices.push(r),r});return n.vertices.push(r[0]),r}function i(e,n,o,t){var r=h.audioStrength,a=h.noiseStrength,i=h.circularStrength,c=m.data;angular.forEach(n,function(e,n){var s=n%h.bands,l=(j-1-n)%h.bands,u=c?(c[s]+c[l])/2/h.bands:0,d=1===t?0:64,p=o*j+(n+d+W)%j,g=o*j+(j-1-n-d+W)%j,v=(h.noiseMap[p]+h.noiseMap[g])/2/64,m=1-(_-o)/_*i,f=e.sincos.base+e.sincos.increment*v+e.sincos.increment*u+a*v*m+r*u*m+0;e.sincos.radius=f,e.x=e.sincos.x*e.sincos.radius,e.y=e.sincos.y*e.sincos.radius,e.z=10*t}),e.verticesNeedUpdate=!0}function c(){angular.forEach(V,function(e,n){i(e.geometry,C[n],n,1),O&&M[n].setGeometry(k[n])}),angular.forEach(D,function(e,n){i(e.geometry,R[n],n,2),O&&L[n].setGeometry(A[n])}),P.rotation.z+=.001,z.rotation.z-=.001;var n=v.getStepAtIndex(e);x.position.copy(n.circle.position);var o=g.ribbon.cameraSpline.getPointAt((e+.1)/v.steps.length);o.y+=v.values.targetHeight,u.position.copy(o),u.scale.x=u.scale.y=u.scale.z=.001+.14*G.pow,u.lookAt(E.position),s()}function s(){b.opacity=G.pow,y.opacity=G.pow,H.opacity=G.pow,y.color=v.values.lines,H.color=v.values.overLines}var l,u,d=v.steps[e],p=(new THREE.TextureLoader).load(d.circle.texture);p.wrapS=THREE.RepeatWrapping,p.wrapT=THREE.RepeatWrapping,p.repeat.set(1,1);var f=new THREE.Vector2(window.innerWidth,window.innerHeight),b=new THREE.MeshBasicMaterial({color:16777215,map:p,transparent:!0}),y=new THREE.LineBasicMaterial({color:v.values.lines,transparent:!0}),H=new THREE.LineBasicMaterial({color:v.values.overLines,transparent:!0}),S=new MeshLineMaterial({color:v.values.lines,lineWidth:1,depthTest:!1,opacity:1,transparent:!0,resolution:f}),T=new MeshLineMaterial({color:v.values.overLines,lineWidth:1,depthTest:!1,opacity:1,transparent:!0,resolution:f});u=new THREE.Object3D;var C=[],R=[],M=[],L=[],k=[],A=[],O=!0,j=h.points,_=h.lines,x=new THREE.Object3D;u.add(x),l=new THREE.PlaneGeometry(2*h.radius-20,2*h.radius-20,8,8);var $=new THREE.Mesh(l,b);$.position.z=-30,x.add($);var P=new THREE.Object3D;x.add(P);var z=new THREE.Object3D;x.add(z);var V=new Array(_).fill(null).map(t),D=new Array(_).fill(null).map(r),G={pow:0,duration:2.35,enabled:!1,adding:!1,removing:!1},W=0;return{add:n,remove:o,object:u,state:G,update:c,updateMaterial:s}}function u(){m.update(),C&&C.update(),g.ribbon&&g.ribbon.update(),angular.forEach(g.circles,function(e){e&&e.state.enabled&&e.update()}),b.render(w,E)}function d(){f.begin(),u(),f.end(),requestAnimationFrame(d)}var p=a.data;if(p){var g=p.objects,h=n,v=t,m=r;h.noiseMap=e(h.points,h.lines);var f,w,E,b,y,H,S,T,C=null;a.$on("onStepChanged",function(e,n){console.log("onStepChanged",n.current);var o=null,t=n.current,r=n.previous;t>0&&(o=g.circles[t]||l(t),o.add()),g.circles[t]=o,setTimeout(function(){if(v.current!==r&&r>0){var e=g.circles[r];e&&e.remove()}},1e3*v.duration),console.log("objects",g)}),a.$on("onStepComplete",function(e,n){console.log("onStepComplete",n.current)}),a.$on("onOptionsChanged",function(e){g.ribbon&&g.ribbon.updateMaterial(),angular.forEach(g.circles,function(e){e&&e.updateMaterial()})}),function(){y=window.innerWidth,H=window.innerHeight,S=y/2,T=H/2;var e=y/H;w=new THREE.Scene,E=new THREE.PerspectiveCamera(30,e,.001,2e4),b=new THREE.WebGLRenderer({alpha:!0,antialias:!0,logarithmicDepthBuffer:!0}),b.setClearColor(0,0),b.setSize(y,H),f=new Stats,i[0].appendChild(b.domElement),i[0].appendChild(f.dom)}(),function(){g.ribbon=s(),g.circles=new Array(v.steps).fill(null)}(),function(){function e(){y=window.innerWidth,H=window.innerHeight,S=y/2,T=H/2,b.setSize(y,H),E.aspect=y/H,E.updateProjectionMatrix()}window.addEventListener("resize",e,!1)}(),d(),m.init()}}}}])}(),function(){"use strict";var e=angular.module("app");e.constant("SceneOptions",{colors:{background:15395048,lines:3363748,overLines:11845597},camera:{cameraHeight:0,targetHeight:5},circle:{position:new THREE.Vector3},ribbon:{steps:12,points:24,vertices:2400},audioVolume:.9,bands:128,points:128,lines:32,radius:200,audioStrength:100,noiseStrength:25,circularStrength:.9}),e.controller("RootCtrl",["$scope","SceneOptions","StepperService","DatGui",function(e,n,o,t){var r={objects:{},options:n,stepper:o},a=r.stepper;a.init().then(function(){e.scene=r,e.stepper=a;new t})}]),e.service("StepperService",["$rootScope","$q","$http","SceneOptions",function(e,n,o,t){function r(){return new Array(v.ribbon.steps).fill().map(function(e,n){return{id:n+1,name:"Step "+(n+1),colors:angular.copy(t.colors),camera:{cameraHeight:0,targetHeight:0},circle:{position:new THREE.Vector3(0,0,0),texture:"img/rossini-01.png"},audio:{url:"audio/07-rossini-192.mp3"}}})}function a(){var e=n.defer();return o.get("json/rossini.js").then(function(n){var o=r();angular.forEach(o,function(e){e.circle.position=(new THREE.Vector3).copy(e.circle.position),f.push(e)}),console.log("StepperService.load",f),e.resolve(f)},function(n){e.reject(n)}),e.promise}function i(){for(;w.length;){w.pop().kill()}}function c(e,n,o,t){i();var r=new THREE.Color(n.colors.background),a=new THREE.Color(n.colors.lines),c=new THREE.Color(n.colors.overLines);w.push(TweenLite.to(h.values,o,{pow:e,cameraHeight:n.camera.cameraHeight,targetHeight:n.camera.targetHeight,delay:0,ease:Power2.easeInOut,onComplete:function(){t&&t()}})),w.push(TweenLite.to(h.values.background,o,{r:r.r,g:r.g,b:r.b,delay:0,ease:Power2.easeInOut,onUpdate:function(){var e=h.values.background.getHexString();document.body.style.backgroundColor="#"+e}})),w.push(TweenLite.to(h.values.lines,o,{r:a.r,g:a.g,b:a.b,delay:0,ease:Power2.easeInOut})),w.push(TweenLite.to(h.values.overLines,o,{r:c.r,g:c.g,b:c.b,delay:0,ease:Power2.easeInOut}))}function s(n){var o=h.current,t=f[o];c(o/f.length,t,n,function(){i(),console.log(t,h.values),e.$broadcast("onStepComplete",{current:o})})}function l(n){var o=h.current||0;h.current=n;var t=f[n];v.colors.background=t.colors.background,v.colors.lines=t.colors.lines,v.colors.overLines=t.colors.overLines,v.camera.cameraHeight=t.camera.cameraHeight,v.camera.targetHeight=t.camera.targetHeight,v.circle.position.copy(t.circle.position),e.$broadcast("onStepChanged",{current:n,previous:o}),s(h.duration)}function u(){m++,m=Math.min(f.length-1,m),l(m)}function d(){m--,m=Math.max(0,m),l(m)}function p(){return f[m]}function g(e){return f[e]}var h=this,v=t,m=0,f=[],w=[],E={pow:0,background:new THREE.Color(v.colors.background),lines:new THREE.Color(v.colors.lines),overLines:new THREE.Color(v.colors.overLines),cameraHeight:v.camera.cameraHeight,targetHeight:v.camera.targetHeight};e.$on("onOptionsChanged",function(){var e=h.current,n=f[e];h.values.cameraHeight=n.camera.cameraHeight,h.values.targetHeight=n.camera.targetHeight,h.values.background.copy(new THREE.Color(n.colors.background)),h.values.lines.copy(new THREE.Color(n.colors.lines)),h.values.overLines.copy(new THREE.Color(n.colors.overLines))}),this.init=a,this.values=E,this.duration=2.5,this.steps=f,this.current=m,this.next=u,this.previous=d,this.getCurrentStep=p,this.getStepAtIndex=g}]),e.factory("DatGui",["$rootScope","SceneOptions","StepperService",function(e,n,o){function t(){function t(n){var o=i.getCurrentStep();o.colors.background=a.colors.background,o.colors.lines=a.colors.lines,o.colors.overLines=a.colors.overLines,o.camera.cameraHeight=a.camera.cameraHeight,o.camera.targetHeight=a.camera.targetHeight,o.circle.position.copy(a.circle.position),e.$broadcast("onOptionsChanged")}var a=n,i=o,c=new dat.GUI;a.randomize=function(){for(var e=0;e<c.__controllers.length;e++){var n=c.__controllers[e];if(n.__min){var o=n.__min+(n.__max-n.__min)*Math.random();this[n.property]=o,n.updateDisplay()}n.__color&&(n.__color.r=Math.floor(255*Math.random()),n.__color.g=Math.floor(255*Math.random()),n.__color.b=Math.floor(255*Math.random()),n.updateDisplay(),n.setValue(n.__color.hex))}},a.saveJson=function(){console.log("saveJson"),r(i.steps,"rossini.js",!0,!0)},c.closed=!0,c.add(a.camera,"cameraHeight",-20,20).listen().onChange(t),c.add(a.camera,"targetHeight",-20,20).listen().onChange(t);var s=c.addFolder("circlePosition");s.add(a.circle.position,"x",-300,300).listen().onChange(t),s.add(a.circle.position,"y",-300,300).listen().onChange(t),s.add(a.circle.position,"z",-300,300).listen().onChange(t);var l=c.addFolder("colors");return l.addColor(a.colors,"background").listen().onChange(t),l.addColor(a.colors,"lines").listen().onChange(t),l.addColor(a.colors,"overLines").listen().onChange(t),c.add(a,"audioVolume",.01,1).onChange(t),c.add(a,"audioStrength",10,100).onChange(t),c.add(a,"noiseStrength",10,100).onChange(t),c.add(a,"circularStrength",.01,.9).onChange(t),c.add(a,"randomize"),c.add(a,"saveJson"),t(),c}var r=function(){var e=document.createElement("a");return document.body.appendChild(e),e.style="display: none",function(n,o,t,r){t&&(n=r?JSON.stringify(n,null,2):JSON.stringify(n));var a=new Blob([n],{type:"octet/stream"}),i=window.URL.createObjectURL(a);e.href=i,e.download=o,e.click(),window.URL.revokeObjectURL(i)}}();return t}]),e.directive("scrollbar",[function(){return{restrict:"A",link:function(e,n,o,t){function r(){a=Scrollbar.init(i,c),e.$watch(a.targets.content.offsetHeight,function(e){a.update()})}var a,i=n[0],c={speed:1,damping:.1,overscrollDamping:1,thumbMinSize:20,continuousScrolling:!0,alwaysShowTracks:!1};setTimeout(r,100)}}}])}();
//# sourceMappingURL=app.min.js.map
